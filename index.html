<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BizAnalyzer Pro - AI駆動ビジネスプラン分析</title>
  <style>
    /* CSSは省略：すでにデザインOKな状態として維持 */
  </style>
</head>
<body>
  <div class="container">
    <form id="analysisForm">
      <input type="text" id="appName" name="appName" placeholder="アプリ名" required>
      <input type="text" id="industry" name="industry" placeholder="業界" required>
      <textarea id="description" name="description" placeholder="概要" required></textarea>
      <input type="text" id="revenueModel" name="revenueModel" placeholder="収益モデル" required>
      <input type="text" id="timeframe" name="timeframe" placeholder="事業期間" required>
      <input type="number" id="budget" name="budget" placeholder="予算" required>
      <button type="submit" id="analyzeButton"><span id="buttonText">送信</span></button>
    </form>
    <div id="errorMessage" class="error-message"></div>
    <div id="resultsSection" class="results-section">
      <div id="analysisResults"></div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      class BizAnalyzer {
        constructor() {
          this.form = document.getElementById('analysisForm');
          if (!this.form) {
            console.error('フォームが見つかりません'); return;
          }
          this.button = document.getElementById('analyzeButton');
          this.buttonText = document.getElementById('buttonText');
          this.resultsSection = document.getElementById('resultsSection');
          this.resultsContainer = document.getElementById('analysisResults');
          this.errorMessage = document.getElementById('errorMessage');

          this.form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.analyzeBusinessPlan();
          });
        }

        async analyzeBusinessPlan() {
          const data = Object.fromEntries(new FormData(this.form).entries());
          this.setLoading(true);
          this.hideError();

          try {
            const res = await fetch('/api/analyze', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!result.analysis) throw new Error('APIからのresponseにanalysisがありません');
            this.displayResults(result.analysis, data);
          } catch (err) {
            this.showError('分析中にエラーが発生しました: ' + err.message);
          } finally {
            this.setLoading(false);
          }
        }

        displayResults(analysis, data) {
          const sections = analysis.split(/(?=【[^】]+】)/).map(block => {
            const match = block.match(/【([^】]+)】([\s\S]*)/);
            return match ? { title: match[1], content: match[2].trim() } : null;
          }).filter(Boolean);
          this.resultsContainer.innerHTML = sections.map((s, i) => `
            <div class="result-card">
              <div class="result-title">${['🎯','💼','📢','💰','⚠️','🚀'][i] || '📊'} ${s.title}</div>
              <div class="result-content">${s.content.replace(/\n/g, '<br>')}</div>
            </div>`).join('');
          this.resultsSection.classList.add('active');
          this.resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        setLoading(loading) {
          this.button.disabled = loading;
          this.buttonText.innerHTML = loading ? '<div class="loading"><div class="spinner"></div>AI分析中...</div>' : '🔍 AI分析を開始';
        }

        showError(msg) {
          this.errorMessage.textContent = msg;
          this.errorMessage.classList.add('active');
          this.errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        hideError() {
          this.errorMessage.classList.remove('active');
        }
      }

      new BizAnalyzer();
    });
  </script>
</body>
</html>
